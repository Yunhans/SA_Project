<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>首頁</title>

  <link href="statics/css/bootstrap.min.css" rel="stylesheet">
  <link href="statics/icons/font/bootstrap-icons.min.css" rel="stylesheet">
  <script src="statics/js/bootstrap.min.js"></script>
  <script src="statics/js/hugo.js"></script>
  <script src="statics/js/jquery-3.4.1.min.js" crossorigin="anonymous"></script>
</head>
<body>  
    <!-- navbar -->
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
        <div class="container-fluid">
          <button class="navbar-toggler border-0 ps-1" type="button" data-bs-toggle="collapse" data-bs-target="#navbarTogglerDemo03" aria-controls="navbarTogglerDemo03" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <a class="navbar-brand ms-1" aria-current="page" href="index.html">學生資源分享站</a>
            <div class="collapse navbar-collapse" id="navbarTogglerDemo03">
                <ul class="navbar-nav me-auto ms-2 mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="index.html">
                            <i class="bi bi-house-door-fill"></i> 首頁
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="member_page" href="member.html">
                          <i class="bi bi-person"></i> 個人主頁
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="alert_page" href="#">
                            <i class="bi bi-chat"></i> 通知欄
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="admin_page" href="admin.html" style="display: none;">
                            <i class="bi bi-database"></i> 連線測試
                        </a>
                    </li>
                </ul>
                <!-- search bar -->
                <form role="search">
                    <div class="input-group">
                      <span class="input-group-text bg-white text-secondary border-end-0 ms-1 pe-2" id="basic-addon1"><i class="bi bi-search"></i></span>
                      <input type="search" class="form-control border-start-0 me-1 ps-2" placeholder="搜尋" aria-label="Search" aria-describedby="basic-addon1">
                    </div>
                </form>
                <div class="text-center">
                    <a type="button" id="loginBtn" class="btn btn-primary mx-1 my-2" href="login.html">
                      <i class="bi bi-box-arrow-in-right"></i> 登入
                    </a>
                </div>
                <div class="text-center">
                    <a type="button" id="logoutBtn" class="btn btn-outline-danger mx-1 my-2" onclick="logout()" style="display: none;">
                      <i class="bi bi-box-arrow-right"></i> 登出
                    </a>
                </div>
            </div>
        </div>
    </nav>
    
    <main>
  
    <div class="album py-5">
      <div class="container" id="post_container">
        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-xl-4 g-3">

          <div class="col">
            <div class="card">
              <img class="bd-placeholder-img card-img-top object-fit-cover" width="100%" height="225" src="" alt="文件檔案"></img>
              <div class="card-body">
                <h5 class="card-title">標題</h5>
                <p class="card-text text-truncate">這裡寫文件說明</p>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="badge rounded-pill text-bg-dark">類別</span>
                  <small class="text-body-secondary">by 作者</small>
                </div>
              </div>
            </div>
          </div>
          
        </div>
      </div>
    </div>
  
    </main>

    <script>
        // 確認登入狀況
        checkLoginStatus();
        getAllPost();

        function checkLoginStatus() {
          const memberLoggedIn = getCookie('memberLoggedIn');
          const adminLoggedIn = getCookie('adminLoggedIn');

          if (memberLoggedIn === 'true' || adminLoggedIn === 'true') {
            // 用戶已登入
            document.getElementById('loginBtn').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'block';
            if(adminLoggedIn === 'true'){
              document.getElementById('member_page').style.display = 'none';
              document.getElementById('alert_page').style.display = 'none';
              document.getElementById('admin_page').style.display = 'block';
            }else{
              document.getElementById('member_page').style.display = 'block';
              document.getElementById('alert_page').style.display = 'block';
            }
          } else {
            // 用戶未登入
            document.getElementById('loginBtn').style.display = 'block';
            document.getElementById('logoutBtn').style.display = 'none';
            document.getElementById('member_page').style.display = 'none';
            document.getElementById('alert_page').style.display = 'none';
          }
        }

        function getAllPost() {
          $.ajax({
            type: "GET",
            url: "api/post.do",
            crossDomain: true,
            cache: false,
            dataType: 'json',
            timeout: 5000,
            success: function (response) {
              // alert("成功連線到伺服器！");
              updatePosts(response.response.data);
              if(response.status == 200){
                updatePosts(response.response.data);
              }
              console.log(response);
            },
            error: function () {
              alert("無法連線到伺服器！");
            }
          });
        }

        function updatePosts(data){
          $("#post_container > div").empty();
          console.log("clear post");
          var post_html = '';
          var post_type = '';
          var initial_file_path = 'filepath/notebook.pdf';
          $.each(data, function(index, value) {
            if(value["page"] == 1){
              console.log(value["file_path"], index);
              if(typeof value["file_path"] == 'undefined'){
                post_html += '<div class="col"><div class="card"><img class="bd-placeholder-img card-img-top object-fit-cover" width="100%" height="225" src=" '+ initial_file_path +' " alt="文件檔案"></img>';
              }else {
                post_html += '<div class="col"><div class="card"><img class="bd-placeholder-img card-img-top object-fit-cover" width="100%" height="225" src=" '+ value["file_path"] +' " alt="文件檔案"></img>';
              }
              post_html += '<div class="card-body"><h5 class="card-title">' + value["post_title"] + '</h5>';
              post_html += '<p class="card-text text-truncate">' + value["post_description"] + '</p>';
              switch(value["post_type"]){
                case 'course_note':
                  console.log('筆記');
                  post_type = '筆記';
                  break;
                case 'course_material':
                  console.log('教材');
                  post_type = '教材';
                  break;
                case 'course_feedback':
                  console.log('課程評價');
                  post_type = '課程評價';
                  break;
                default:
                  console.log('無法分辨檔案類型');
              }
              post_html += '<div class="d-flex justify-content-between align-items-center"><span class="badge rounded-pill text-bg-dark">' + post_type + '</span>';
              post_html += '<small class="text-body-secondary">by ' + value["member_name"] + '</small></div></div></div></div>';
            }else{
              console.log('page not 1');
            }
                
          })

          $("#post_container > div").append(post_html);
        }
    </script>

</body>
</html>